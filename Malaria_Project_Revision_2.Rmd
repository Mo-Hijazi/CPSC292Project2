---
title: "TEST PROJECT"
author: "Mo Hijazi"
date: "10/16/2021"
output: html_document
---
---
title: "Project 1 - Malaria"
author: "Mo Hijazi"
date: "10/12/2021"
output: html_document
---
```{r}
# All libraries required for code.
library(ggplot2)
library(reshape2)
library(tidyr)
library(janitor)
library(viridis)
library(viridisLite)
library(maps)
library(tidyverse)
library(scales)
library(gganimate)
library(gifski)
library(dplyr)
library(gapminder)
library(ggthemes)
library(readr)
library(magick)
library(magrittr)
```

Loading in the data set "malaria_data.csv." The data set contains malaria related deaths in different countries in relation to age. 
```{r, include=T}
knitr::opts_chunk$set(echo = TRUE)

#Loading in the csv file. 
malaria <- read.csv("malaria_data_2.csv", skip = 1)
```

Cleaning up the data set: 
```{r, include=T}
#Renaming specific countries on the data to match the world map names.
malaria$Entity[1401:1428] <- "Ivory Coast"
malaria$Entity[1345:1372] <- "Democratic Republic of the Congo"
malaria$Entity[1541:1568] <- "Democratic Republic of the Congo"
malaria$Entity[1065:1092] <- "China"
malaria$Entity[1121:1148] <- "Spain"
malaria$Entity[1681:1708] <- "China"
malaria$Entity[5209:5236] <- "China"
malaria$Entity[5293:5348] <- "China"

#Making sure the data is numeric for calculations.
malaria$Entity <- factor(malaria$Entity) 
#Cleaning up the column names, removing unneeded columns, and omitting any NA values.
malaria <- clean_names(malaria)
malaria <- subset(malaria, select = -2) %>% 
  na.omit(malaria)

for(i in 1990:2017){
  clean.malaria <- malaria[malaria$year==i,] #Isolating specific year
  rownames(clean.malaria) <- seq(length=nrow(clean.malaria)) #Renumbering rows
  clean.malaria <- rowSums(clean.malaria[1:230,3:7]) #Summing up the columns for each country. 
  malaria.all.forloop <- assign(paste0("malaria.all.",i), clean.malaria) 
  malaria.country <- data.frame("region" = malaria[,1], "deaths" = malaria.all.forloop) 
  assign(paste0("malaria.all.",i),malaria.country) #combining the data with a df of countries.
}
```

Combining world map data with my data to create visual:
```{r echo=FALSE}
Malaria.Map.F <- function(df.year,year,save.name){
  mapdata <- map_data("world")
  d <- df.year %>%
  right_join(mapdata, by= "region") %>%
  group_by(region)%>% 
  filter_if(~is.numeric(.), all_vars(!is.infinite(.)))

d <- subset(d, select = -7)
d$deaths <- log(d$deaths)

wtihout_canvas = ggplot(d, aes(long, lat, group=group))+
  geom_polygon(aes(fill=deaths), na.rm="black")+ 
  scale_fill_viridis(name = "Number of Deaths", breaks = c(2,10), labels=c("Low death rates", "High death rates"), limits = c(0,12))+
  labs(title = paste("Average Number of Malaria Related Deaths in Different Countries (Year:",year,")"),
       caption = "** Gray regions do not have malaria deaths or data pretaining to number of malaria deaths **")+
  theme_void()
ggsave(save.name,height = 6, width=9)
}

for(i in 1990:2017){
  df.year <- paste0("malaria.all.",i)
  year <- i
  save.name <- paste0("Mo-NewPlot.",i,".png")
  Malaria.Map.F(df.year,year,save.name)
}
```

```{r}
list.files(pattern = '*.png', full.names = TRUE) %>% 
        image_read() %>% # reads each path file
        image_join() %>% # joins image
        image_animate(fps=1) %>% # animates, can opt for number of loops
        image_write("Mo-AnimatedMap.gif") # write to current dir
```
***UPDATES FOR VISUAL 1***
Hannah Sukhdeo, Sarah Fraschetti, Azure Gilmore: I log-ed all death values making the range of deaths much more compact. This created a better representation with the color gradient I used. 

I used the "without_canvas" function to reduce amount of computing needed when creating the map. This reduced the time from ~25 minutes to ~15 seconds! YAY!

I added a title and a caption describing the gray regions of the map. 

I animated the map by year! (For this I had to save the maps for each year as a PNG which took forever. I noticed saving to PDF took way less time; however, I couldn't get R to convert from PDF to PNG.)

VISUAL 2:
```{r, include=T}
#Loading in the csv file. 
Visual2malaria <- read.csv("malaria_data.csv", skip = 1)
#creating a data frame with just "world" death counts
Visual2malaria <- data.frame(Visual2malaria[6357:6384,]) 
#Removing unneeded columns
Visual2malaria <- subset(Visual2malaria, select = -2)
Visual2malaria <- subset(Visual2malaria, select = -1)
#making year counts as characters for easier visual edits. 
Visual2malaria$Year <- as.character(Visual2malaria$Year)
#Combining column deaths. 
total.deaths <- rowSums(Visual2malaria[,2:6])
year <- Visual2malaria$Year
#Creating a new data fram with years and total deaths.
malaria.world <- cbind(year, total.deaths)
malaria.world <- as.data.frame(malaria.world)

```


```{r, include=T}
#Making all death counts into numeric values.
malaria.world$total.deaths <- as.numeric(malaria.world$total.deaths)
#Creating bar graph and making aes edits to bar graph.
ggplot(malaria.world, aes(x= year, y= total.deaths, fill = year))+
  theme_dark()+
  geom_bar(stat = "identity")+ 
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1))+
  scale_y_continuous(name="Total Deaths", breaks= seq(0,1500000, by= 100000), labels = comma, expand = c(0, 0))+
  xlab("Year")+
  ggtitle("Total Malaria Deaths per Year")+
  theme(legend.position = "none")+ 
  theme(plot.title = element_text(hjust = 0.5))
```
***UPDATE***
Hannah Sukhdeo: You mentioned to add percentages to each of the brag graph I don't think this would be proper for this visual as each graph is a total number of deaths for each year.


------------------------------------------------------------------------------------------------------------------------
***Resources***
https://stackoverflow.com/questions/61838700/query-on-how-to-make-world-heat-map-using-ggplot-in-r
https://stackoverflow.com/questions/42683522/r-how-to-sum-a-variable-by-certain-levels-contained-in-a-list-of-another-varia
https://www.youtube.com/watch?v=AgWgPSZ7Gp0
https://stackoverflow.com/questions/13353213/gradient-of-n-colors-ranging-from-color-1-and-color-2
https://stackoverflow.com/questions/60268389/china-not-showing-on-chloropleth-map-in-r
https://www.youtube.com/watch?v=AgWgPSZ7Gp0
https://www.datanovia.com/en/blog/how-to-remove-legend-from-a-ggplot/
https://www.datanovia.com/en/lessons/rename-data-frame-columns-in-r/
http://www.sthda.com/english/wiki/ggplot2-barplots-quick-start-guide-r-software-and-data-visualization
https://www.r-graph-gallery.com/218-basic-barplots-with-ggplot2.html
https://stackoverflow.com/questions/1330989/rotating-and-spacing-axis-labels-in-ggplot2
https://www.datanovia.com/en/blog/how-to-set-ggplot-breaks/
http://www.sthda.com/english/wiki/ggplot2-axis-ticks-a-guide-to-customize-tick-marks-and-labels
https://stackoverflow.com/questions/40675778/center-plot-title-in-ggplot2
https://statisticsglobe.com/change-formatting-of-numbers-of-ggplot2-plot-axis-in-r
https://stackoverflow.com/questions/13701347/force-the-origin-to-start-at-0
https://www.datasciencemadesimple.com/delete-or-drop-rows-in-r-with-conditions-2/
https://stackoverflow.com/questions/56389470/convert-multiple-png-to-gif-as-an-animation-in-r



